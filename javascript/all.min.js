<<<<<<< HEAD
'use strict';

var $userimage = $('#userimage .inner'),
    $coverimage = $('#coverimage .inner'),
    $dragger = $('#dragger'),
    $sizer = $('#size-slider'),
    $loading = $('#loading'),
    $uploading = $('#uploading');

$(window).load(function () {
    var container_size = $userimage.width(),
        userimage_size = getImgSize(getBackgroundImage($userimage));
    resizeDragger(userimage_size, container_size);
});
$(document).ready(function () {
    // ie alert
    $("body").iealert({
        support: 'ie9',
        title: '您的瀏覽器太舊啦！',
        text: '請更新您的瀏覽器，我們推薦您使用 Google Chrome',
        closeBtn: false,
        upgradeTitle: '下載 Google Chrome',
        upgradeLink: 'http://www.google.com/chrome/'
    });
    $('body').keydown(function (e) {
        switch (event.keyCode) {
            case 37:
                break;
            case 39:
                break;
        }
    }

    // dragger
    );$dragger.draggable({
        drag: function drag(event) {
            $userimage.css('background-position', $dragger.css('left') + ' ' + $dragger.css('top'));
            if ($userimage.hasClass('dragged') == false) $userimage.addClass('dragged');
            var value = $('input[name=template]:checked').val();
            if (value == 9 || value == 10) $userimage.attr('class', 'inner');
        }
    });

    // size slider
    $sizer.slider({
        value: 100,
        max: 170,
        min: 30,
        slide: function slide(event, ui) {
            var truesize = getBackgroundSize($userimage.css('background-size')),
                position = getBackgroundPosition($userimage.css('background-position')),
                center = getBackgroundCenterPoint(truesize, position);
            $('<img/>').attr('src', getBackgroundImage($userimage)).load(function () {
                var size = [this.width, this.height],
                    width = size[0] * ui.value / 100,
                    height = size[1] * ui.value / 100,
                    left = center[0] - width * 0.5,
                    top = center[1] - height * 0.5;
                $dragger.css('width', width + 'px').css('height', height + 'px').css('top', top + 'px').css('left', left + 'px');
                $userimage.css('background-size', width + 'px ' + height + 'px').css('background-position', left + 'px ' + top + 'px');
            });
        }
    });

    // change template
    $('body').delegate('input[name=template]', 'change', function () {
        var width,
            value = $(this).val(),
            url = 'images/object/' + value + '.png';

        $coverimage.css('background-image', 'url(' + url + ')');
        if ($userimage.hasClass('dragged') == true) $userimage.attr('class', 'inner dragged');else $userimage.attr('class', 'inner');

        $('<img/>').attr('src', getBackgroundImage($userimage)).load(function () {
            var size = [this.width, this.height],
                container_size = $userimage.width();
            resizeDragger(size, container_size, value);
        });
    });

    $("#normalSubmit").click(function () {
        var basesize = $userimage.width(),
            size = getBackgroundSize($userimage.css('background-size')),
            position = getBackgroundPosition($userimage.css('background-position')),
            scale = basesize / 500;

        var template = $('input[name=template]:checked').val(),
            source = $('#source').val(),
            w = size[0] / scale,
            h = size[1] / scale,
            x = position[0] / scale,
            y = position[1] / scale;
        createImage(template, source, x, y, w, h);
    });
});
// $(window).konami({
//   code : [55,55,55],
//   cheat: function() {
//     $('.banana').slideDown();
//   }
// });
// $(window).konami({
//   code : [54,54,54],
//   cheat: function() {
//     $('h1,#size-slider').delay(100).animate({'opacity':'0'},2900)
//     $('#formbuttons,.template-label').delay(400).animate({'opacity':'0'},2600)
//     $('#settings').delay(1000).animate({'opacity':'0'},2000)
//     $('.left-bottom-corner').delay(800).animate({'opacity':'0'},2200)
//     $('.preview').animate({'top':'-500px','opacity':'0.5'},3000).animate({'width':'0','opacity':'0'},3000,function(){
//       $('#content').slideUp();
//     })
//   }
// });

function createImage(template, source, x, y, w, h) {
    var cover = new Image();
    cover.src = 'images/object/' + template + '.png';

    var userimage = new Image();
    userimage.src = source;

    var resize_canvas = document.getElementById("result");
    resize_canvas.width = 500;
    resize_canvas.height = 500;

    var ctx = resize_canvas.getContext("2d");
    ctx.rect(0, 0, 500, 500);
    ctx.fillStyle = "#CCCCCC";
    ctx.fill();
    ctx.drawImage(userimage, x, y, w, h);
    ctx.drawImage(cover, 0, 0, 500, 500);

    var base64 = resize_canvas.toDataURL("image/png");

    // check ie or not
    var ua = window.navigator.userAgent;
    var msie = ua.indexOf("MSIE ");
    if (msie > 0 || !!navigator.userAgent.match(/Trident.*rv\:11\./)) {
        var html = "<p>請按右鍵另存圖片</p>";
        html += "<img src='" + base64 + "' alt='10'/>";
        var tab = window.open();
        tab.document.write(html);
    } else {
        $('#download').attr('href', base64);
        $('#download').attr('download', +new Date() + '.png');
        $('#download')[0].click();
    }
}

//uploader
$(function () {
    var dropZone = document.getElementById('drop');
    dropZone.addEventListener('dragover', handleDragOver, false);
    dropZone.addEventListener('drop', handleFileSelect, false);

    $('.uploadBtn').click(function () {
        $('#uploadInput').click();
    });
    $('#uploadInput').on('change', function () {
        input = document.getElementById('uploadInput');
        loadImage(input.files);
    });
});

// drag image
function handleFileSelect(evt) {
    evt.stopPropagation();
    evt.preventDefault();
    var files = evt.dataTransfer.files;
    loadImage(files);
}
function handleDragOver(evt) {
    evt.stopPropagation();
    evt.preventDefault();
    evt.dataTransfer.dropEffect = 'copy';
}

// function
function loadImage(files) {
    var file, fr, img;
    if (!files) {
        alert('悲劇！您的瀏覽器不支援檔案上傳！');
    } else {
        $uploading.fadeIn();
        $loading.show();
        file = files[0];
        fr = new FileReader();
        fr.onload = createImage;
        fr.readAsDataURL(file);
    }
    function createImage() {
        img = new Image();
        img.onload = imageLoaded;
        img.src = fr.result;
    }

    function imageLoaded() {
        var canvas = document.getElementById("canvas");
        canvas.width = img.width;
        canvas.height = img.height;
        var ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0);
        var base64 = canvas.toDataURL("image/png");

        $('#source').attr('value', base64);
        $userimage.css('background-image', 'url(' + base64 + ')');

        var thumb = document.getElementById("thumb");
        var thumb_w, thumb_h;
        if (img.width > img.height) {
            thumb_h = 100;
            thumb_w = 100 * (img.width / img.height);
        } else {
            thumb_w = 100;
            thumb_h = 100 * (img.height / img.width);
        }
        thumb.width = thumb_w;
        thumb.height = thumb_h;
        var ctx = thumb.getContext("2d");
        ctx.drawImage(img, 0, 0, thumb_w, thumb_h);
        var thumbbase64 = thumb.toDataURL("image/png");
        $('#templates label').css('background-image', 'url(' + thumbbase64 + ')');

        $('<img/>').attr('src', base64).load(function () {
            var value = $('input[name=template]:checked').val(),
                container_size = $userimage.width(),
                userimage_size = [this.width, this.height];
            resizeDragger(userimage_size, container_size, value);

            $loading.hide();
            $uploading.fadeOut();
        });
    }
}
function getImgSize(src) {
    var newImg = new Image();
    newImg.src = src;
    return [newImg.width, newImg.height];
}
function getBackgroundImage(element) {
    var url = element.css('background-image');
    return url.replace(/^url\(["']?/, '').replace(/["']?\)$/, '');
}
function resizeDragger(size, wrapper, value, upload) {
    value = typeof value !== 'undefined' ? value : 1;
    upload = typeof upload !== 'undefined' ? upload : 0;

    var scale, width, height, top, left;
    if (size[0] > size[1]) {
        scale = wrapper / size[1];
        width = size[0] * scale;
        height = wrapper;
        top = 0;
        left = (width - wrapper) * 0.5 * -1;
    } else {
        scale = wrapper / size[0];
        width = wrapper;
        height = size[1] * scale;
        top = (height - wrapper) * 0.5 * -1;
        left = 0;
    }

    if (value == 6) {
        left = wrapper * 0.2 * -1;
        if (size[0] > size[1]) left -= (width - wrapper) * 0.5;
    } else if (value == 9) {
        $sizer.slider('value', 65);
        if (size[0] > size[1]) {
            left = wrapper * 0.65 * 0.13 * 0.5;
            width *= 0.65;
            height *= 0.65;
            top = (wrapper - height) * 0.48;
        } else {
            left = wrapper * 0.65 * 0.13 * 0.5;
            width *= 0.65;
            height *= 0.65;
            top = (wrapper - height) * 0.48;
        }
    } else if (value == 10) {
        $sizer.slider('value', 92);
        if (size[0] > size[1]) {
            width = wrapper * 0.92;
            height = width * (size[1] / size[0]);
            top = wrapper * 0.045;
            left = (wrapper - width) * 0.5;
        } else {
            width = width * 0.92;
            height = height * 0.92;
            top = wrapper * 0.045;
            left = (wrapper - width) * 0.5;
        }
    }

    $dragger.css('width', width + 'px').css('height', height + 'px').css('top', top + 'px').css('left', left + 'px');
    $userimage.css('background-size', width + 'px ' + height + 'px').css('background-position', left + 'px ' + top + 'px');
}
function getBackgroundSize(string) {
    size = string.split(' ');
    return [px2int(size[0]), px2int(size[1])];
}
function getBackgroundPosition(string) {
    position = string.split(' ');
    return [px2int(position[0]), px2int(position[1])];
}
function getBackgroundCenterPoint(size, position) {
    return [size[0] * 0.5 + position[0], size[1] * 0.5 + position[1]];
}
function px2int(string) {
    return parseFloat(string.replace('px', ''));
}
=======
function createImage(e,a,t,i,n,r){var o=new Image;o.src="images/object/"+e+".png";var g=new Image;g.src=a;var s=document.getElementById("result");s.width=500,s.height=500;var d=s.getContext("2d");d.rect(0,0,500,500),d.fillStyle="#CCCCCC",d.fill(),d.drawImage(g,t,i,n,r),d.drawImage(o,0,0,500,500);var c=s.toDataURL("image/png"),u=window.navigator.userAgent,l=u.indexOf("MSIE ");if(l>0||navigator.userAgent.match(/Trident.*rv\:11\./))
{var m="<p>請按右鍵另存圖片</p>";m+="<img src='"+c+"' alt='10'/>";var p=window.open();p.document.write(m)}else $("#download").attr("href",c),$('#download').attr('download',(+ new Date())+'.png'),$("#download")[0].click()}function handleFileSelect(e){e.stopPropagation(),e.preventDefault();var a=e.dataTransfer.files;loadImage(a)}function handleDragOver(e){e.stopPropagation(),e.preventDefault(),e.dataTransfer.dropEffect="copy"}function loadImage(e){function a(){r=new Image,r.onload=t,r.src=n.result}function t(){var e=document.getElementById("canvas");e.width=r.width,e.height=r.height;var a=e.getContext("2d");a.drawImage(r,0,0);var t=e.toDataURL("image/png");$("#source").attr("value",t),$userimage.css("background-image","url("+t+")");var i,n,o=document.getElementById("thumb");r.width>r.height?(n=100,i=100*(r.width/r.height)):(i=100,n=100*(r.height/r.width)),o.width=i,o.height=n;var a=o.getContext("2d");a.drawImage(r,0,0,i,n);var g=o.toDataURL("image/png");$("#templates label").css("background-image","url("+g+")"),$("<img/>").attr("src",t).load(function(){var e=$("input[name=template]:checked").val(),a=$userimage.width(),t=[this.width,this.height];resizeDragger(t,a,e),$loading.hide(),$uploading.fadeOut()})}var i,n,r;e?($uploading.fadeIn(),$loading.show(),i=e[0],n=new FileReader,n.onload=a,n.readAsDataURL(i)):alert("悲劇！您的瀏覽器不支援檔案上傳！")}function getImgSize(e){var a=new Image;return a.src=e,[a.width,a.height]}function getBackgroundImage(e){var a=e.css("background-image");return a.replace(/^url\(["']?/,"").replace(/["']?\)$/,"")}function resizeDragger(e,a,t,i){t="undefined"!=typeof t?t:1,i="undefined"!=typeof i?i:0;var n,r,o,g,s;e[0]>e[1]?(n=a/e[1],r=e[0]*n,o=a,g=0,s=.5*(r-a)*-1):(n=a/e[0],r=a,o=e[1]*n,g=.5*(o-a)*-1,s=0),6==t?(s=.2*a*-1,e[0]>e[1]&&(s-=.5*(r-a))):9==t?($sizer.slider("value",65),e[0]>e[1]?(s=.65*a*.13*.5,r*=.65,o*=.65,g=.48*(a-o)):(s=.65*a*.13*.5,r*=.65,o*=.65,g=.48*(a-o))):10==t&&($sizer.slider("value",92),e[0]>e[1]?(r=.92*a,o=r*(e[1]/e[0]),g=.045*a,s=.5*(a-r)):(r=.92*r,o=.92*o,g=.045*a,s=.5*(a-r))),$dragger.css("width",r+"px").css("height",o+"px").css("top",g+"px").css("left",s+"px"),$userimage.css("background-size",r+"px "+o+"px").css("background-position",s+"px "+g+"px")}function getBackgroundSize(e){return size=e.split(" "),[px2int(size[0]),px2int(size[1])]}function getBackgroundPosition(e){return position=e.split(" "),[px2int(position[0]),px2int(position[1])]}function getBackgroundCenterPoint(e,a){return[.5*e[0]+a[0],.5*e[1]+a[1]]}function px2int(e){return parseFloat(e.replace("px",""))}var $userimage=$("#userimage .inner"),$coverimage=$("#coverimage .inner"),$dragger=$("#dragger"),$sizer=$("#size-slider"),$loading=$("#loading");$uploading=$("#uploading"),$(window).load(function(){var e=$userimage.width(),a=getImgSize(getBackgroundImage($userimage));resizeDragger(a,e)}),$(document).ready(function(){$("body").iealert({support:"ie9",title:"您的瀏覽器太舊啦！",text:"請更新您的瀏覽器，我們推薦您使用 Google Chrome",closeBtn:!1,upgradeTitle:"下載 Google Chrome",upgradeLink:"http://www.google.com/chrome/"}),$dragger.draggable({drag:function(e){$userimage.css("background-position",$dragger.css("left")+" "+$dragger.css("top")),0==$userimage.hasClass("dragged")&&$userimage.addClass("dragged");var a=$("input[name=template]:checked").val();(9==a||10==a)&&$userimage.attr("class","inner")}}),$sizer.slider({value:100,max:170,min:30,slide:function(e,a){var t=getBackgroundSize($userimage.css("background-size")),i=getBackgroundPosition($userimage.css("background-position")),n=getBackgroundCenterPoint(t,i);$("<img/>").attr("src",getBackgroundImage($userimage)).load(function(){var e=[this.width,this.height],t=e[0]*a.value/100,i=e[1]*a.value/100,r=n[0]-.5*t,o=n[1]-.5*i;$dragger.css("width",t+"px").css("height",i+"px").css("top",o+"px").css("left",r+"px"),$userimage.css("background-size",t+"px "+i+"px").css("background-position",r+"px "+o+"px")})}}),$("body").delegate("input[name=template]","change",function(){var e=$(this).val(),a="images/object/"+e+".png";$coverimage.css("background-image","url("+a+")"),1==$userimage.hasClass("dragged")?$userimage.attr("class","inner dragged"):$userimage.attr("class","inner"),$("<img/>").attr("src",getBackgroundImage($userimage)).load(function(){var a=[this.width,this.height],t=$userimage.width();resizeDragger(a,t,e)})}),$("#normalSubmit").click(function(){var e=$userimage.width(),a=getBackgroundSize($userimage.css("background-size")),t=getBackgroundPosition($userimage.css("background-position")),i=e/500,n=$("input[name=template]:checked").val(),r=$("#source").val(),o=a[0]/i,g=a[1]/i,s=t[0]/i,d=t[1]/i;createImage(n,r,s,d,o,g)})}),$(window).konami({code:[55,55,55],cheat:function(){$(".banana").slideDown()}}),$(window).konami({code:[54,54,54],cheat:function(){$("h1,#size-slider").delay(100).animate({opacity:"0"},2900),$("#formbuttons,.template-label").delay(400).animate({opacity:"0"},2600),$("#settings").delay(1e3).animate({opacity:"0"},2e3),$(".left-bottom-corner").delay(800).animate({opacity:"0"},2200),$(".preview").animate({top:"-500px",opacity:"0.5"},3e3).animate({width:"0",opacity:"0"},3e3,function(){$("#content").slideUp()})}}),$(function(){var e=document.getElementById("drop");e.addEventListener("dragover",handleDragOver,!1),e.addEventListener("drop",handleFileSelect,!1),$(".uploadBtn").click(function(){$("#uploadInput").click()}),$("#uploadInput").on("change",function(){input=document.getElementById("uploadInput"),loadImage(input.files)})});
>>>>>>> gh-pages
